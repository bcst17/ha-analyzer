<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Supervisor PRO - 全方位督導分析儀</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0F4F8; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .input-panel { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        
        #image-paste-zone {
            transition: all 0.2s ease;
            border: 2px dashed #CBD5E1;
        }
        #image-paste-zone.active {
            border-color: #6366F1;
            background-color: #EEF2FF;
        }
        .preview-img {
            max-height: 180px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white/70 backdrop-blur-lg border-b border-slate-200">
        <div class="max-w-screen-2xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-indigo-600 to-violet-600 p-2 rounded-xl text-white shadow-lg">
                    <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                </div>
                <h1 class="font-black text-xl tracking-tighter text-slate-900 uppercase">Supervisor <span class="text-indigo-600">Intelligence</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <input type="password" id="api-key-input" placeholder="Gemini API Key" class="bg-slate-100 border-none text-xs rounded-full py-2 px-4 w-48 focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all">
                <div class="flex items-center gap-2 px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-[10px] font-bold">
                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                    2024-25 DATABASE CONNECTED
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-screen-2xl mx-auto px-6 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Left: Input & History Meta -->
        <div class="lg:col-span-4 space-y-6">
            <div class="glass-card bg-white rounded-[2rem] p-6 shadow-xl shadow-slate-200/50 border border-slate-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-black text-slate-800 flex items-center gap-2 uppercase tracking-tight">
                        <i data-lucide="edit-3" class="w-5 h-5 text-indigo-500"></i> 工作日誌輸入
                    </h2>
                </div>
                
                <textarea id="log-input" class="w-full h-72 p-5 bg-slate-50 border border-slate-200 rounded-2xl text-sm leading-relaxed focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none resize-none" placeholder="貼上當日服務細節、客戶主訴、測試過程..."></textarea>
                
                <!-- Image Paste Zone -->
                <div class="mt-4">
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">聽力圖貼上 (選填)</label>
                    <div id="image-paste-zone" class="relative overflow-hidden min-h-[100px] flex flex-col items-center justify-center bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 hover:border-indigo-400 cursor-pointer transition-all">
                        <div id="image-placeholder" class="text-center p-4">
                            <i data-lucide="image" class="w-6 h-6 text-slate-300 mx-auto mb-1"></i>
                            <p class="text-[10px] text-slate-400 font-bold italic">直接 Ctrl+V 貼上截圖</p>
                        </div>
                        <div id="image-preview-container" class="hidden relative p-2 w-full flex flex-col items-center">
                            <img id="img-preview" src="" class="preview-img" alt="聽力圖預覽">
                            <button id="remove-img" class="mt-2 text-[10px] font-black text-rose-500 hover:underline">移除圖片</button>
                        </div>
                    </div>
                </div>

                <button id="analyze-btn" class="w-full mt-6 py-4 bg-slate-900 text-white rounded-2xl font-black text-lg flex items-center justify-center gap-3 hover:bg-indigo-600 transition-all active:scale-95 shadow-lg group">
                    <i data-lucide="wand-2" class="w-5 h-5 group-hover:rotate-12 transition-transform"></i>
                    開始 AI 督導診斷
                </button>
            </div>

            <!-- Context Hint -->
            <div class="bg-indigo-50 rounded-3xl p-6 border border-indigo-100">
                <h4 class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-3">督導背景知識庫</h4>
                <p class="text-xs text-indigo-900/70 leading-relaxed font-medium italic">
                    系統已載入 2024-2025 年度所有成交與流失案例。AI 會自動比對「多人環境抱怨」、「長輩品牌偏好」以及「家人支持度低」等歷史關鍵流失因子。
                </p>
            </div>
        </div>

        <!-- Right: Diagnostic Dashboard -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- Welcome/Empty State -->
            <div id="empty-state" class="h-full min-h-[600px] flex flex-col items-center justify-center bg-white rounded-[3rem] border-2 border-dashed border-slate-200 text-slate-300">
                <i data-lucide="layout-dashboard" class="w-16 h-16 opacity-10 mb-4"></i>
                <p class="font-bold tracking-widest uppercase">等待數據輸入中...</p>
            </div>

            <!-- Loading -->
            <div id="loading-state" class="hidden h-full min-h-[600px] flex flex-col items-center justify-center bg-white rounded-[3rem]">
                <div class="relative">
                    <div class="w-20 h-20 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
                    <i data-lucide="cpu" class="w-6 h-6 text-indigo-600 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                </div>
                <p class="mt-6 font-black text-slate-800 tracking-widest uppercase text-sm italic">AI 正在串接歷史數據並分析聽力圖<span class="loading-dots"></span></p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden space-y-6">
                
                <!-- Top Row: Scores -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Service Score -->
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col items-center justify-center text-center">
                        <div class="w-24 h-24 mb-3 relative">
                            <canvas id="scoreChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center font-black text-2xl text-slate-800" id="score-val">0</div>
                        </div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">流程完整度</span>
                    </div>

                    <!-- Conversion Chance -->
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col justify-center">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">成交潛力指標</span>
                            <span id="chance-badge" class="px-2 py-0.5 rounded-full text-[9px] font-black"></span>
                        </div>
                        <div class="text-4xl font-black text-slate-900 mb-3" id="conversion-val">0%</div>
                        <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                            <div id="conversion-bar" class="h-full bg-indigo-600 transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Audio Graph Insight (Dynamic) -->
                    <div id="audio-card" class="bg-slate-900 text-white p-6 rounded-[2.5rem] shadow-xl flex flex-col justify-center relative overflow-hidden">
                        <div class="relative z-10">
                            <h4 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">聽力判讀分析</h4>
                            <p id="audio-summary" class="text-xs leading-relaxed font-bold text-slate-300 italic">尚未提供聽力圖...</p>
                        </div>
                        <i data-lucide="waves" class="absolute -right-4 -bottom-4 w-24 h-24 text-white/5 rotate-12"></i>
                    </div>
                </div>

                <!-- Middle Row: Personality & Emotional Radar -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <!-- Radar Chart -->
                    <div class="md:col-span-5 bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">客情多維度分析</h4>
                        <div class="h-48 flex items-center justify-center">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <!-- User Profile Card -->
                    <div class="md:col-span-7 bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-6">
                        <div class="flex items-center gap-4">
                            <div id="disc-avatar" class="w-16 h-16 rounded-2xl flex items-center justify-center text-2xl font-black shadow-inner">?</div>
                            <div>
                                <h3 class="font-black text-xl text-slate-800" id="profile-name">分析中...</h3>
                                <p class="text-xs text-slate-400 font-bold" id="profile-disc">DISC Personality Type</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 rounded-2xl">
                                <span class="text-[9px] font-black text-slate-400 uppercase">性格特徵</span>
                                <p class="text-xs font-bold text-slate-700 mt-1" id="profile-trait">--</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl">
                                <span class="text-[9px] font-black text-slate-400 uppercase">核心需求</span>
                                <p class="text-xs font-bold text-indigo-600 mt-1" id="profile-need">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Strategy & Script -->
                <div class="bg-indigo-600 rounded-[3rem] p-10 text-white shadow-2xl shadow-indigo-200 relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-6">
                            <i data-lucide="message-circle" class="w-6 h-6"></i>
                            <h3 class="font-black text-xl">推薦成交話術與引導邏輯</h3>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                            <div>
                                <p class="text-[10px] font-black text-indigo-200 uppercase tracking-widest mb-3">精選金句</p>
                                <blockquote id="sales-script" class="text-2xl font-black leading-tight mb-4 tracking-tight">「...」</blockquote>
                            </div>
                            <div class="space-y-4">
                                <div class="bg-white/10 p-5 rounded-3xl border border-white/10">
                                    <p class="text-[10px] font-black text-indigo-200 uppercase tracking-widest mb-2">督導指令 (重點叮嚀)</p>
                                    <p id="supervisor-instruction" class="text-sm font-bold leading-relaxed">分析中...</p>
                                </div>
                                <div class="bg-white/10 p-5 rounded-3xl border border-white/10">
                                    <p class="text-[10px] font-black text-indigo-200 uppercase tracking-widest mb-2">話術邏輯</p>
                                    <p id="script-logic" class="text-sm font-medium text-indigo-100 italic">分析中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Decorative background icon -->
                    <i data-lucide="quote" class="absolute -right-8 -bottom-8 w-48 h-48 text-white/5 -rotate-12"></i>
                </div>

                <!-- Final AP Summary -->
                <div class="bg-white rounded-[2.5rem] p-10 border border-slate-200">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2 font-black text-slate-800">
                            <i data-lucide="check-circle" class="w-5 h-5 text-emerald-500"></i>
                            ACTION PLAN (AP) 總結
                        </div>
                        <button id="copy-ap" class="text-xs font-black px-4 py-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-all flex items-center gap-2">
                            <i data-lucide="copy" class="w-3 h-3"></i> 複製內容
                        </button>
                    </div>
                    <div id="ap-summary" class="font-mono text-sm font-bold bg-slate-50 p-6 rounded-3xl border border-slate-100 text-slate-700 leading-relaxed whitespace-pre-wrap">--</div>
                </div>

            </div>
        </div>
    </main>

    <script>
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        let scoreChart, radarChart;
        let base64Image = null;

        lucide.createIcons();

        // Elements
        const dropZone = document.getElementById('image-paste-zone');
        const imgPreview = document.getElementById('img-preview');
        const previewContainer = document.getElementById('image-preview-container');
        const placeholder = document.getElementById('image-placeholder');
        const removeImgBtn = document.getElementById('remove-img');
        const analyzeBtn = document.getElementById('analyze-btn');
        const logInput = document.getElementById('log-input');
        const apiKeyInput = document.getElementById('api-key-input');

        // Paste Image Implementation
        window.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    handleFile(blob);
                }
            }
        });

        dropZone.onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => handleFile(e.target.files[0]);
            input.click();
        };

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                base64Image = e.target.result.split(',')[1];
                imgPreview.src = e.target.result;
                placeholder.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                dropZone.classList.add('active');
            };
            reader.readAsDataURL(file);
        }

        removeImgBtn.onclick = (e) => {
            e.stopPropagation();
            base64Image = null;
            imgPreview.src = "";
            placeholder.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            dropZone.classList.remove('active');
        };

        // Analysis Logic
        analyzeBtn.addEventListener('click', async () => {
            const text = logInput.value.trim();
            const apiKey = apiKeyInput.value.trim() || "";

            if (!text) return alert("請輸入服務日誌內容");

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');

            try {
                const systemPrompt = `你是一位專業的助聽器銷售與聽力督導。
                請根據日誌內容與(如果有提供)聽力圖截圖，進行深度分析。
                參考歷史流失數據(2024-25)：常因為家人意見、安靜環境效果與吵雜環境落差、辨識力預期不符而流失。
                
                必須回傳 JSON：
                {
                  "score": 1-5,
                  "conversion": 1-100,
                  "audio_analysis": "對聽力圖的具體判讀(如: 高頻陡降、平坦型、辨識力受限等)",
                  "personality": { "type": "DISC類型", "traits": "性格特質描述", "need": "底層需求" },
                  "radar": [情緒分數, 期望分數, 信任分數, 預算意願, 理解力],
                  "instruction": "督導給人員的實戰建議",
                  "script": "推薦成交話術",
                  "script_logic": "為什麼這樣說的心理邏輯",
                  "ap": "最後的 AP 總結回饋"
                }`;

                const contents = [{
                    role: "user",
                    parts: [{ text: `服務日誌：\n${text}\n\n指令：\n${systemPrompt}` }]
                }];

                if (base64Image) {
                    contents[0].parts.push({
                        inlineData: { mimeType: "image/png", data: base64Image }
                    });
                }

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents, generationConfig: { responseMimeType: "application/json" } })
                });

                const rawData = await response.json();
                const data = JSON.parse(rawData.candidates[0].content.parts[0].text);
                
                renderDashboard(data);
                
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                alert("分析失敗，請檢查 API Key 或日誌內容格式。");
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            }
        });

        function renderDashboard(data) {
            // Scores
            document.getElementById('score-val').textContent = data.score;
            document.getElementById('conversion-val').textContent = `${data.conversion}%`;
            document.getElementById('conversion-bar').style.width = `${data.conversion}%`;
            
            const badge = document.getElementById('chance-badge');
            badge.textContent = data.conversion > 60 ? "HIGH CHANCE" : "LOW CHANCE";
            badge.className = `px-2 py-0.5 rounded-full text-[9px] font-black ${data.conversion > 60 ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`;

            // Audio Analysis
            document.getElementById('audio-summary').textContent = data.audio_analysis || "未偵測到聽力圖圖像資訊。";

            // Profile
            document.getElementById('profile-name').textContent = `Customer - ${data.personality.type} Type`;
            document.getElementById('profile-disc').textContent = `DISC: ${data.personality.type}`;
            document.getElementById('profile-trait').textContent = data.personality.traits;
            document.getElementById('profile-need').textContent = data.personality.need;
            
            const avatar = document.getElementById('disc-avatar');
            avatar.textContent = data.personality.type[0];
            const colors = { D: '#EF4444', I: '#F59E0B', S: '#10B981', C: '#3B82F6' };
            avatar.style.backgroundColor = colors[data.personality.type[0]] || '#CBD5E1';
            avatar.style.color = 'white';

            // Strategy
            document.getElementById('sales-script').textContent = `「${data.script}」`;
            document.getElementById('supervisor-instruction').textContent = data.instruction;
            document.getElementById('script-logic').textContent = data.script_logic;
            document.getElementById('ap-summary').textContent = data.ap;

            // Charts
            updateCharts(data);
        }

        function updateCharts(data) {
            // Score Donut
            if (scoreChart) scoreChart.destroy();
            scoreChart = new Chart(document.getElementById('scoreChart'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [data.score, 5 - data.score],
                        backgroundColor: ['#6366F1', '#F1F5F9'],
                        borderWidth: 0,
                        circumference: 360,
                        rotation: 0
                    }]
                },
                options: { cutout: '80%', plugins: { legend: { display: false } } }
            });

            // Radar
            if (radarChart) radarChart.destroy();
            radarChart = new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: {
                    labels: ['情緒', '期望', '信任', '預算', '理解'],
                    datasets: [{
                        label: '維度分數',
                        data: data.radar,
                        borderColor: '#6366F1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        pointBackgroundColor: '#6366F1',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 10, ticks: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        document.getElementById('copy-ap').onclick = () => {
            const content = document.getElementById('ap-summary').innerText;
            const el = document.createElement('textarea');
            el.value = content;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("已複製 AP 內容");
        };
    </script>
</body>
</html>
